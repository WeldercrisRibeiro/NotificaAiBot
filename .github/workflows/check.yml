name: Check Infarma CAB versions

on:
  schedule:
    - cron: "0 12 * * 1" # toda segunda 12:00 UTC (09:00 Fortaleza ~ UTC-3)
  workflow_dispatch: {}   # bot√£o "Run workflow" (consultar na hora)

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (needed for cache file)
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run checker
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          BASE_URL: https://s3.amazonaws.com/infarma-cv/2504a
        run: |
          node <<'NODE'
          const fs = require("fs");
          const https = require("https");

          const BASE_URL = process.env.BASE_URL;
          const TOKEN = process.env.TELEGRAM_BOT_TOKEN;
          const CHAT_ID = process.env.TELEGRAM_CHAT_ID;

          const PRODUCTS = {
            VmdRrd: "Varejo",
            VmdTrm: "Terminal",
            VmdPdv: "Caixa",
            VmdImpRlj: "Importa√ß√£o de dados Loja",
            VmdImp: "Importa√ß√£o de dados Central",
            VmdSrv: "Infarma Servi√ßo",
          };

          const STATE_FILE = ".state.json";

          function head(url) {
            return new Promise((resolve, reject) => {
              const req = https.request(url, { method: "HEAD" }, (res) => {
                const etag = (res.headers.etag || "").toString();
                const lm = (res.headers["last-modified"] || "").toString();
                const len = Number(res.headers["content-length"] || 0);
                if (res.statusCode >= 200 && res.statusCode < 400) resolve({ etag, lm, len });
                else reject(new Error(`HEAD failed ${res.statusCode}`));
              });
              req.on("error", reject);
              req.end();
            });
          }

          function sendTelegram(text) {
            const payload = JSON.stringify({ chat_id: CHAT_ID, text });
            return new Promise((resolve, reject) => {
              const req = https.request(
                `https://api.telegram.org/bot${TOKEN}/sendMessage`,
                { method: "POST", headers: { "Content-Type": "application/json", "Content-Length": Buffer.byteLength(payload) } },
                (res) => {
                  let data = "";
                  res.on("data", (c) => (data += c));
                  res.on("end", () => (res.statusCode >= 200 && res.statusCode < 300) ? resolve(data) : reject(new Error(data)));
                }
              );
              req.on("error", reject);
              req.write(payload);
              req.end();
            });
          }

          async function main() {
            if (!TOKEN || !CHAT_ID) throw new Error("Missing TELEGRAM_BOT_TOKEN/TELEGRAM_CHAT_ID secrets.");

            const state = fs.existsSync(STATE_FILE) ? JSON.parse(fs.readFileSync(STATE_FILE, "utf8")) : {};

            const changes = [];
            for (const [key, name] of Object.entries(PRODUCTS)) {
              const url = `${BASE_URL}/${key}.CAB`;
              const info = await head(url);
              const sig = `etag=${info.etag}|lm=${info.lm}|len=${info.len}`;
              const prev = state[key];

              if (!prev) {
                state[key] = sig; // inicializa sem avisar
                continue;
              }

              if (prev !== sig) {
                changes.push({ key, name, url, prev, sig, info });
                state[key] = sig;
              }
            }

            fs.writeFileSync(STATE_FILE, JSON.stringify(state, null, 2));

            if (changes.length === 0) {
              console.log("No changes.");
              return;
            }

            for (const c of changes) {
              const msg =
                `üÜï Nova vers√£o detectada!\n\n` +
                `Produto: ${c.name} (${c.key})\n` +
                `Link: ${c.url}\n\n` +
                `Antes: ${c.prev}\n` +
                `Agora:  ${c.sig}\n\n` +
                `Detalhes:\n` +
                `- ETag: ${c.info.etag}\n` +
                `- Last-Modified: ${c.info.lm}\n` +
                `- Size: ${c.info.len} bytes`;
              await sendTelegram(msg);
            }
          }

          main().catch((e) => {
            console.error(e);
            process.exit(1);
          });
          NODE

      - name: Commit state if changed
        run: |
          if git status --porcelain | grep -q ".state.json"; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add .state.json
            git commit -m "Update state"
            git push
          else
            echo "No state changes to commit."
          fi